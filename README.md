🧠 CodeFixAI 改善履歴まとめ
🔹 第1段階：基本構造の実装

目的： Ollama + Gemma を使って、Pythonコードを自動修正できる環境を構築。

主な内容：

requests.post()でOllama APIを呼び出し。

GradioでWebUIを構築（入力欄・出力欄）。

「コードを入力 → Gemmaが修正版を出力」までの流れを実装。

課題：

AIがMarkdown形式で出力するため、余計なテキストや解説が混ざった。

正常なコードでも修正版を返すことがあった。

出力欄が小さく、見づらかった。

🔹 第2段階：構文チェック機能の導入

目的： 「本当に修正が必要な場合だけAIに依頼」できるようにする。

主な改善点：

astモジュールを使い、is_valid_python()関数で構文チェックを追加。

構文エラーがあるときだけneeds_fix=TrueとしてGemmaに修正を依頼。

修正不要なら "✅ 正常に実行できます" を返す仕様に変更。

効果：

無駄なAI呼び出しが減り、処理が軽くなった。

「構文が正しい」場合に明確な結果を返すようになった。

残った課題：

Gemmaが「Markdownコードブロック」で出力するため、Python構文としてast.parse()できないケースが発生。

🔹 第3段階：AI出力の正規化

目的： Gemmaの出力形式を解析して、純粋なPythonコードだけを抽出する。

主な改善点：

extract_python_code()関数を新設。

正規表現 (re.search) で python … や … の中身を取り出す。

コードブロックがない場合は、そのままテキストを返す。

効果：

Markdown混じりのAI出力にも対応。

"✅ 正常に実行できます" と純粋なコード出力を正確に区別可能に。

🔹 第4段階：エラー処理と安定性強化

目的： 実運用でも落ちない堅牢な処理を目指す。

主な改善点：

response.raise_for_status()でHTTPエラーをキャッチ。

AIからの応答が空の場合 → "⚠️ AIからの応答がありませんでした。" を返す。

構文エラー以外の例外もtry-except Exceptionで網羅。

temperature=0.0 を指定して、Gemmaの回答を安定化。

出力が空でも安全にハンドリングするよう修正。

効果：

Ollamaが不安定な状態でもクラッシュしない。

同じ入力に対して安定した結果を返す。

🔹 第5段階：UIとユーザー体験の改善

目的： 実際に使いやすいWebツールとしての完成度を上げる。

主な改善点：

Gradioの入力・出力欄を両方lines=15に設定（見やすくした）。

入力欄にサンプルコード（FizzBuzz）をプレースホルダー表示。

出力欄に「ここに結果が表示されます」とガイドを追加。

タイトル・説明文をわかりやすく更新。

効果：

UIとして自然なレイアウトに。

学習用途・実用ツールの両方で使いやすい。

🔹 第6段階（現在の状態）：完成度の高い自動修正AI

現時点の特徴：
✅ 構文チェック機能（ast）
✅ AI出力正規化機能（extract_python_code()）
✅ エラー処理・HTTP検知・応答検証
✅ 安定した推論出力（temperature=0.0）
✅ Gradioによる視覚的インターフェース
✅ 安全設計（構文不正時のフォールバックメッセージ）

🧩 今後の発展アイデア（次のステップ）
機能	内容
💾 修正版を自動保存	修正版コードを fixed_code.py に自動保存。
🧮 構文エラー位置の特定	SyntaxError 例外からエラー行・内容をGUI表示。
🔁 再修正機能	「AI修正版をもう一度チェックして修正」ボタン追加。
🧠 複数モデル対応	Gemma以外（Mistral・Phiなど）を選択可能に。
📊 精度ログ出力	修正成功率・AI出力傾向をログ化。
